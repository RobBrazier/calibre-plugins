version: "3"

vars:
  PLUGINS:
    sh: "ls plugins"

tasks:
  default:
    silent: true
    cmd: "{{ .TASK_EXE }} --list-all"

  install:
    desc: Install dependencies
    cmd: uv sync --all-packages

  test:
    desc: Run tests
    cmd: uv run pytest
    env:
      PYTHONPATH: "{{ .PYTHONPATH }}:"

  clean:
    desc: Clean temporary / build files
    cmds:
      - find "{{ .ROOT_DIR }}" \( ! -regex '.*/\..*' \) -name 'dist' -type d | xargs -r -- rm -r

  package:
    desc: Package all plugins
    cmds:
      - for: { var: PLUGINS }
        task: "package:{{ .ITEM }}"

  package:*:
    desc: Package a single plugin
    vars:
      PLUGIN: "{{ index .MATCH 0 }}"
      PLUGIN_DIR: "{{ .ROOT_DIR }}/plugins/{{ .PLUGIN }}"
    cmds:
      - mkdir -p "{{ .ROOT_DIR }}/dist"
      - uv --directory "{{ .PLUGIN_DIR }}" run hatch build -t zipped-directory
      # - cp "{{ .PLUGIN_DIR }}/dist/{{ .PLUGIN }}*.zip" "{{ .ROOT_DIR }}/dist/"
    sources:
      - "{{ .PLUGIN_DIR }}/**/*.py"
      - "{{ .ROOT_DIR }}/src/**/*.py"
    generates:
      - "{{ .PLUGIN_DIR }}/dist/{{ .PLUGIN }}*.zip"

  install:*:
    desc: Install a single plugin
    vars:
      PLUGIN: "{{ index .MATCH 0 }}"
      PLUGIN_NAME: "{{ index .MATCH 0 | title }}"
    deps:
      - "package:{{.PLUGIN}}"
    cmds:
      - for: { var: PLUGINS }
        cmd: find "{{ .ROOT_DIR }}/plugins/{{ .ITEM }}/dist" -name '*.zip' -type f | xargs calibre-customize --add-plugin
    sources:
      - "{{ .ROOT_DIR }}/plugins/{{ .PLUGIN }}/dist/{{ .PLUGIN }}*.zip"
    generates:
      - "{{ .DEVENV_DOTFILE }}/config/calibre/plugins/{{ .PLUGIN_NAME }}.zip"

  run:*:
    desc: Run a single plugin
    vars:
      PLUGIN: "{{ index .MATCH 0 }}"
      PLUGIN_NAME: "{{ index .MATCH 0 | title }}"
    deps:
      - "install:{{.PLUGIN}}"
    cmd: calibre-debug -r {{ .PLUGIN_NAME }} -- {{.CLI_ARGS}}

  calibre:setup:
    desc: Setup Calibre for first use
    requires:
      vars:
        - CALIBRE_TEMP_DIR
        - CALIBRE_LIBRARY
    vars:
      BOOKS:
        - "1513.epub.noimages" # Romeo and Juliet
        - "345.epub.noimages" # Dracula
    cmds:
      - for: { var: BOOKS }
        cmd: wget -P "{{ .CALIBRE_TEMP_DIR }}" --content-disposition "https://www.gutenberg.org/ebooks/{{ .ITEM }}"
      - defer: find "{{ .CALIBRE_TEMP_DIR }}" -name "*.epub" | xargs -r rm
      - cmd: find "{{ .CALIBRE_TEMP_DIR }}" -type f -name "*.epub" | xargs calibredb add --with-library {{ .CALIBRE_LIBRARY }}
      - cmd: calibre --with-library {{ .CALIBRE_LIBRARY }}

  calibre:run:
    desc: Start Calibre in Debug Mode
    cmd: calibre-debug -g -- {{.CLI_ARGS}}
